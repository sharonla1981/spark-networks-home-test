--merge to ods - weather forecast
insert into ods_weather_forecast (station_name,station_id,weather_tstamp,tmp,tmax_degc,tmin_degc,rain_mm_3h)
with fc_base as (
		select
			weather_data->'city'->>'name' station_name
			,weather_data->'city'->>'id' station_id
			,weather_data->'list' list
		from stg_fc
	),
	fc_flatten_json as (
	select
		station_name
		,station_id
		,json_array_elements(list) fc_data
	from fc_base
	)
	select
		station_name
		,cast(station_id as int) station_id
		,to_timestamp(cast(fc_data->>'dt' as int)) weather_tstamp
		,cast(fc_data->'main'->>'temp' as double precision) tmp
		,cast(fc_data->'main'->>'temp_max' as double precision) tmax_degc
		,cast(fc_data->'main'->>'temp_min' as double precision) tmin_degc
		,cast(fc_data->'rain'->>'3h' as double precision) rain_mm_3h
	from fc_flatten_json
on conflict (station_id,weather_tstamp)
do update
	set tmp = excluded.tmp
	,tmax_degc = excluded.tmax_degc
	,tmin_degc = excluded.tmin_degc
	,rain_mm_3h = excluded.rain_mm_3h
	,dwh_last_modified = current_timestamp;


--merge to ods - current weather
insert into ods_current_weather (station_name,station_id,weather_tstamp,tmp,tmax_degc,tmin_degc,rain_mm_1h,rain_mm_3h)
select weather_data->>'name' station_name
		,cast(weather_data->>'id' as int) station_id
		,to_timestamp(cast(weather_data->>'dt' as int)) weather_tstamp
		,cast(weather_data->'main'->>'temp' as double precision) tmp
		,cast(weather_data->'main'->>'temp_max' as double precision) tmax_degc
		,cast(weather_data->'main'->>'temp_min' as double precision) tmin_degc
		,cast(weather_data->'rain'->>'1h' as double precision) rain_mm_1h
		,cast(weather_data->'rain'->>'3h' as double precision) rain_mm_3h
from stg_current
on conflict (station_id,weather_tstamp)
do update
	set tmp = excluded.tmp
	,tmax_degc = excluded.tmax_degc
	,tmin_degc = excluded.tmin_degc
	,rain_mm_1h = excluded.rain_mm_1h
	,rain_mm_3h = excluded.rain_mm_3h
	,dwh_last_modified = current_timestamp;