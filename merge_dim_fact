--merge d_weather station
insert into d_weather_station (station_id,station_name)
select distinct w.station_id,w.station_name
from ods_current_weather w
left join d_weather_station ws on w.station_id = ws.station_id
where ws.sk_weather_station is null


--merge to ods - weather forecast
insert into f_weather_history_monthly (sk_date,sk_weather_station,total_rain_mm,avg_temp,max_temp)
select cast(to_char(cw.weather_tstamp,'yyyymm') as int) sk_date
		,ws.sk_weather_station
		,sum(rain_mm_3h) total_rain_mm
		,avg(cw.tmp) avg_temp
		,max(cw.tmax_degc) max_temp
from ods_current_weather cw
join d_weather_station ws on cw.station_id = ws.station_id
group by 1,2
on conflict (sk_date,sk_weather_station)
do update
	set total_rain_mm = excluded.total_rain_mm
	,avg_temp = excluded.avg_temp
	,max_temp = excluded.max_temp
	,dwh_last_modified = current_timestamp;
